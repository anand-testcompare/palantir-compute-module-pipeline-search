services:
  mock-foundry:
    build:
      context: .
      dockerfile: Dockerfile.mock-foundry
    environment:
      MOCK_FOUNDRY_ADDR: ":8080"
      MOCK_FOUNDRY_INPUT_DIR: "/data/inputs"
      MOCK_FOUNDRY_UPLOAD_DIR: "/data/uploads"
    volumes:
      - ./test/fixtures/mock-foundry/inputs:/data/inputs:ro
      - ./test/artifacts/mock-foundry/uploads:/data/uploads

  mock-gemini:
    build:
      context: .
      dockerfile: Dockerfile.mock-gemini
    environment:
      MOCK_GEMINI_ADDR: ":8081"

  enricher:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - mock-foundry
      - mock-gemini
    environment:
      FOUNDRY_URL: "http://mock-foundry:8080"
      BUILD2_TOKEN: "/fixtures/token.txt"
      RESOURCE_ALIAS_MAP: "/fixtures/alias-map.json"
      GEMINI_API_KEY: "dummy-key"
      GEMINI_MODEL: "gemini-2.5-flash"
      GEMINI_BASE_URL: "http://mock-gemini:8081"
      GEMINI_CAPTURE_AUDIT: "true"
    volumes:
      - ./test/fixtures:/fixtures:ro
    command: ["foundry"]
